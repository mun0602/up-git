#!/bin/bash

# =============================================================================
# GITHUB SCRIPT CREATOR - Phi√™n b·∫£n t·ªëi ∆∞u
# T√°c gi·∫£: Your Name
# M√¥ t·∫£: T·∫°o v√† ƒë·∫©y script bash l√™n GitHub m·ªôt c√°ch an to√†n v√† hi·ªáu qu·∫£
# =============================================================================

set -euo pipefail  # Exit on error, undefined vars, pipe failures

# ======================== CONSTANTS & VARIABLES ========================
# Handle script executed via curl | bash
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
    readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    readonly SCRIPT_DIR="$(pwd)"
fi

readonly CONFIG_FILE="$HOME/.github_script_config"
# Use Windows-compatible temp path
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
    readonly LOG_FILE="$HOME/github_script_$(date +%Y%m%d_%H%M%S).log"
else
    readonly LOG_FILE="/tmp/github_script_$(date +%Y%m%d_%H%M%S).log"
fi

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Default values
DEFAULT_EDITOR="${EDITOR:-nano}"
DEFAULT_BRANCH="main"

# ======================== UTILITY FUNCTIONS ========================

# Logging function
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case "$level" in
        "INFO")  echo -e "${GREEN}[INFO]${NC} $message" | tee -a "$LOG_FILE" ;;
        "WARN")  echo -e "${YELLOW}[WARN]${NC} $message" | tee -a "$LOG_FILE" ;;
        "ERROR") echo -e "${RED}[ERROR]${NC} $message" | tee -a "$LOG_FILE" ;;
        "DEBUG") echo -e "${BLUE}[DEBUG]${NC} $message" | tee -a "$LOG_FILE" ;;
    esac
}

# Progress bar
show_progress() {
    local current=$1
    local total=$2
    local width=50
    local percentage=$((current * 100 / total))
    local filled=$((width * current / total))
    
    printf "\r${BLUE}["
    printf "%*s" $filled | tr ' ' '‚ñà'
    printf "%*s" $((width - filled)) | tr ' ' '‚ñë'
    printf "] %d%%${NC}" $percentage
    
    if [ $current -eq $total ]; then
        echo
    fi
}

# Cleanup function
cleanup() {
    log "INFO" "ƒêang d·ªçn d·∫πp t√†i nguy√™n..."
    # Remove temp files if needed
    local temp_pattern="temp_script_$"
    if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        [ -f "$HOME/$temp_pattern" ] && rm -f "$HOME/$temp_pattern"
    else
        [ -f "/tmp/$temp_pattern" ] && rm -f "/tmp/$temp_pattern" 
    fi
}

# Set up cleanup trap
trap cleanup EXIT INT TERM

# ======================== VALIDATION FUNCTIONS ========================

# Validate GitHub URL
validate_github_url() {
    local url="$1"
    
    if [[ ! "$url" =~ ^https://github\.com/[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+\.git$ ]] && 
       [[ ! "$url" =~ ^git@github\.com:[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+\.git$ ]]; then
        log "ERROR" "URL kh√¥ng h·ª£p l·ªá! Format: https://github.com/user/repo.git ho·∫∑c git@github.com:user/repo.git"
        return 1
    fi
    return 0
}

# Validate file name
validate_filename() {
    local filename="$1"
    
    if [[ ! "$filename" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        log "ERROR" "T√™n file ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi v√† d·∫•u g·∫°ch ngang"
        return 1
    fi
    
    if [ ${#filename} -gt 50 ]; then
        log "ERROR" "T√™n file qu√° d√†i (t·ªëi ƒëa 50 k√Ω t·ª±)"
        return 1
    fi
    
    return 0
}

# ======================== CONFIGURATION FUNCTIONS ========================

# Load configuration
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        log "INFO" "ƒê√£ t·∫£i c·∫•u h√¨nh t·ª´ $CONFIG_FILE"
    fi
}

# Save configuration
save_config() {
    local git_name="$1"
    local git_email="$2"
    
    cat > "$CONFIG_FILE" << EOF
# GitHub Script Creator Configuration
DEFAULT_AUTHOR="$git_name"
DEFAULT_EMAIL="$git_email"
DEFAULT_EDITOR="$DEFAULT_EDITOR"
LAST_UPDATED="$(date)"
EOF
    log "INFO" "ƒê√£ l∆∞u c·∫•u h√¨nh v√†o $CONFIG_FILE"
}

# ======================== SSH KEY MANAGEMENT ========================

# Check if SSH key exists
check_ssh_key_exists() {
    local ssh_dir="$HOME/.ssh"
    local key_files=("id_ed25519" "id_rsa" "id_ecdsa")
    
    for key_file in "${key_files[@]}"; do
        if [ -f "$ssh_dir/$key_file" ]; then
            log "INFO" "T√¨m th·∫•y SSH key: $key_file"
            return 0
        fi
    done
    
    log "WARN" "Kh√¥ng t√¨m th·∫•y SSH key n√†o"
    return 1
}

# Generate new SSH key
generate_ssh_key() {
    local email
    local ssh_dir="$HOME/.ssh"
    
    log "INFO" "üîë T·∫°o SSH key m·ªõi cho GitHub..."
    
    # Get email from git config or ask user
    email=$(git config --global user.email 2>/dev/null || echo "")
    
    if [ -z "$email" ]; then
        read -p "Nh·∫≠p email GitHub c·ªßa b·∫°n: " email
        if [ -n "$email" ]; then
            git config --global user.email "$email"
        fi
    fi
    
    # Create .ssh directory if not exists
    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir"
    
    # Generate Ed25519 key (recommended)
    log "INFO" "ƒêang t·∫°o SSH key Ed25519..."
    if ssh-keygen -t ed25519 -C "$email" -f "$ssh_dir/id_ed25519" -N ""; then
        log "INFO" "‚úÖ ƒê√£ t·∫°o SSH key th√†nh c√¥ng!"
        return 0
    else
        log "ERROR" "‚ùå Kh√¥ng th·ªÉ t·∫°o SSH key"
        return 1
    fi
}

# Start SSH agent and add key
setup_ssh_agent() {
    log "INFO" "Thi·∫øt l·∫≠p SSH agent..."
    
    # Start ssh-agent if not running
    if ! pgrep -x "ssh-agent" > /dev/null; then
        eval "$(ssh-agent -s)" > /dev/null
        log "INFO" "ƒê√£ kh·ªüi ƒë·ªông SSH agent"
    fi
    
    # Add key to agent
    local key_files=("$HOME/.ssh/id_ed25519" "$HOME/.ssh/id_rsa" "$HOME/.ssh/id_ecdsa")
    
    for key_file in "${key_files[@]}"; do
        if [ -f "$key_file" ]; then
            if ssh-add "$key_file" 2>/dev/null; then
                log "INFO" "ƒê√£ th√™m key v√†o SSH agent: $(basename "$key_file")"
                return 0
            fi
        fi
    done
    
    log "WARN" "Kh√¥ng th·ªÉ th√™m key v√†o SSH agent"
    return 1
}

# Display public key and guide user to add to GitHub
guide_add_key_to_github() {
    local pub_key_file
    local pub_key_files=("$HOME/.ssh/id_ed25519.pub" "$HOME/.ssh/id_rsa.pub" "$HOME/.ssh/id_ecdsa.pub")
    
    # Find public key file
    for file in "${pub_key_files[@]}"; do
        if [ -f "$file" ]; then
            pub_key_file="$file"
            break
        fi
    done
    
    if [ -z "$pub_key_file" ]; then
        log "ERROR" "Kh√¥ng t√¨m th·∫•y public key file"
        return 1
    fi
    
    echo
    echo "üéØ ================================== QUAN TR·ªåNG =================================="
    echo "üìã Public key c·ªßa b·∫°n (COPY TO√ÄN B·ªò d√≤ng d∆∞·ªõi ƒë√¢y):"
    echo
    echo -e "${GREEN}$(cat "$pub_key_file")${NC}"
    echo
    echo "üîß C√°c b∆∞·ªõc th√™m SSH key v√†o GitHub:"
    echo "   1. M·ªü tr√¨nh duy·ªát v√† truy c·∫≠p: https://github.com/settings/keys"
    echo "   2. Click n√∫t '${GREEN}New SSH key${NC}'"
    echo "   3. ƒê·∫∑t t√™n cho key (v√≠ d·ª•: 'My Windows Laptop')"
    echo "   4. Copy & paste TO√ÄN B·ªò d√≤ng key ·ªü tr√™n v√†o √¥ 'Key'"
    echo "   5. Click '${GREEN}Add SSH key${NC}'"
    echo "   6. Nh·∫≠p password GitHub ƒë·ªÉ x√°c nh·∫≠n"
    echo
    echo "üí° Tip: Tr√™n Windows, d√πng Ctrl+Shift+C ƒë·ªÉ copy trong Git Bash"
    echo "==============================================================================="
    echo
    
    # Auto copy to clipboard if possible
    if command -v clip.exe >/dev/null 2>&1; then
        cat "$pub_key_file" | clip.exe
        log "INFO" "‚úÖ ƒê√£ copy key v√†o clipboard t·ª± ƒë·ªông!"
    elif command -v xclip >/dev/null 2>&1; then
        cat "$pub_key_file" | xclip -selection clipboard
        log "INFO" "‚úÖ ƒê√£ copy key v√†o clipboard t·ª± ƒë·ªông!"
    fi
    
    # Wait for user confirmation
    echo -n "Nh·∫•n Enter sau khi ƒë√£ th√™m SSH key v√†o GitHub..."
    read -r
    
    return 0
}

# Check SSH connection to GitHub with detailed feedback
check_ssh_github() {
    log "INFO" "Ki·ªÉm tra k·∫øt n·ªëi SSH v·ªõi GitHub..."
    
    local ssh_output
    local max_attempts=3
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        # Test SSH connection with detailed output
        ssh_output=$(ssh -o ConnectTimeout=10 -o BatchMode=yes -T git@github.com 2>&1)
        
        if echo "$ssh_output" | grep -q "successfully authenticated"; then
            # Extract username from output
            local username=$(echo "$ssh_output" | grep -o "Hi [^!]*" | cut -d' ' -f2)
            log "INFO" "üéâ SSH connection th√†nh c√¥ng! Xin ch√†o $username"
            return 0
        elif echo "$ssh_output" | grep -q "Permission denied"; then
            log "WARN" "‚ùå SSH key ch∆∞a ƒë∆∞·ª£c add v√†o GitHub ho·∫∑c kh√¥ng ƒë√∫ng"
            if [ $attempt -eq $max_attempts ]; then
                log "ERROR" "Vui l√≤ng ki·ªÉm tra l·∫°i SSH key tr√™n GitHub"
                return 1
            fi
        elif echo "$ssh_output" | grep -q "Connection timed out\|Network is unreachable"; then
            log "WARN" "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn GitHub (l·ªói m·∫°ng)"
            if [ $attempt -eq $max_attempts ]; then
                return 1
            fi
        else
            log "WARN" "‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh: $ssh_output"
            if [ $attempt -eq $max_attempts ]; then
                return 1
            fi
        fi
        
        if [ $attempt -lt $max_attempts ]; then
            log "INFO" "Th·ª≠ l·∫°i l·∫ßn $((attempt + 1))/$max_attempts sau 3 gi√¢y..."
            sleep 3
        fi
        
        attempt=$((attempt + 1))
    done
    
    return 1
}

# ======================== GITHUB FUNCTIONS ========================

# Check if GitHub CLI is available and authenticated
check_github_cli() {
    if command -v gh >/dev/null 2>&1; then
        if gh auth status >/dev/null 2>&1; then
            log "INFO" "GitHub CLI ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c"
            return 0
        else
            log "WARN" "GitHub CLI ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c"
            read -p "B·∫°n c√≥ mu·ªën ƒëƒÉng nh·∫≠p GitHub CLI kh√¥ng? (y/n): " -r
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                gh auth login
                return $?
            fi
        fi
    else
        log "WARN" "GitHub CLI kh√¥ng ƒë∆∞·ª£c c√†i ƒë·∫∑t"
    fi
    return 1
}

# Complete SSH setup process
setup_ssh_github() {
    log "INFO" "üîê Thi·∫øt l·∫≠p SSH connection v·ªõi GitHub..."
    
    # Step 1: Check if SSH key exists
    if ! check_ssh_key_exists; then
        log "INFO" "T·∫°o SSH key m·ªõi..."
        if ! generate_ssh_key; then
            log "ERROR" "Kh√¥ng th·ªÉ t·∫°o SSH key"
            return 1
        fi
    fi
    
    # Step 2: Setup SSH agent
    setup_ssh_agent
    
    # Step 3: Test connection first
    if check_ssh_github; then
        return 0
    fi
    
    # Step 4: If connection fails, guide user to add key to GitHub
    log "INFO" "SSH key ch∆∞a ƒë∆∞·ª£c th√™m v√†o GitHub ho·∫∑c ch∆∞a ƒë√∫ng"
    
    if ! guide_add_key_to_github; then
        return 1
    fi
    
    # Step 5: Test connection again
    log "INFO" "Ki·ªÉm tra l·∫°i k·∫øt n·ªëi SSH..."
    if check_ssh_github; then
        log "INFO" "üéâ SSH setup ho√†n t·∫•t!"
        return 0
    else
        log "ERROR" "SSH connection v·∫´n th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i:"
        echo "  - SSH key ƒë√£ ƒë∆∞·ª£c add v√†o GitHub ch∆∞a?"
        echo "  - Internet connection c√≥ ·ªïn ƒë·ªãnh kh√¥ng?"
        echo "  - Firewall c√≥ block SSH kh√¥ng?"
        return 1
    fi
}

# Setup authentication method
setup_auth() {
    log "INFO" "üîê Thi·∫øt l·∫≠p ph∆∞∆°ng th·ª©c x√°c th·ª±c GitHub..."
    
    # Try GitHub CLI first (fastest if already set up)
    if check_github_cli; then
        return 0
    fi
    
    # Try SSH setup (recommended for long-term use)
    log "INFO" "Thi·∫øt l·∫≠p SSH connection..."
    if setup_ssh_github; then
        return 0
    fi
    
    # If all methods fail, provide instructions
    echo
    log "ERROR" "‚ùå Kh√¥ng th·ªÉ thi·∫øt l·∫≠p x√°c th·ª±c GitHub!"
    echo
    echo "üîß C√°c ph∆∞∆°ng √°n kh√°c:"
    echo "1. C√†i ƒë·∫∑t GitHub CLI:"
    echo "   - Download: https://cli.github.com/"
    echo "   - Ho·∫∑c: winget install GitHub.cli"
    echo "   - Sau ƒë√≥ ch·∫°y: gh auth login"
    echo
    echo "2. Thi·∫øt l·∫≠p SSH key th·ªß c√¥ng:"
    echo "   - https://docs.github.com/en/authentication/connecting-to-github-with-ssh"
    echo
    echo "3. S·ª≠ d·ª•ng HTTPS v·ªõi Personal Access Token:"
    echo "   - T·∫°o token: https://github.com/settings/tokens"
    echo "   - D√πng username + token thay v√¨ password"
    echo
    
    read -p "B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c m√† kh√¥ng x√°c th·ª±c? (y/n): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log "WARN" "‚ö†Ô∏è Ti·∫øp t·ª•c m√† kh√¥ng x√°c th·ª±c - c√≥ th·ªÉ g·∫∑p l·ªói khi push"
        return 0
    fi
    
    return 1
}

# ======================== GIT FUNCTIONS ========================

# Setup Git configuration
setup_git_config() {
    local git_name git_email
    
    # Try to get from existing config
    git_name=$(git config --global user.name 2>/dev/null || echo "${DEFAULT_AUTHOR:-}")
    git_email=$(git config --global user.email 2>/dev/null || echo "${DEFAULT_EMAIL:-}")
    
    if [ -z "$git_name" ] || [ -z "$git_email" ]; then
        log "INFO" "Thi·∫øt l·∫≠p th√¥ng tin Git..."
        
        if [ -z "$git_name" ]; then
            read -p "Nh·∫≠p t√™n c·ªßa b·∫°n: " git_name
        fi
        
        if [ -z "$git_email" ]; then
            read -p "Nh·∫≠p email GitHub c·ªßa b·∫°n: " git_email
        fi
        
        git config --global user.name "$git_name"
        git config --global user.email "$git_email"
        
        # Save to config for next time
        save_config "$git_name" "$git_email"
    fi
    
    log "INFO" "Git config: $git_name <$git_email>"
}

# ======================== FILE MANAGEMENT FUNCTIONS ========================

# Get unique filename
get_unique_filename() {
    local base_name="$1"
    local counter=1
    local folder_name="${base_name}-folder"
    
    while [ -d "$folder_name" ]; do
        folder_name="${base_name}-${counter}-folder"
        counter=$((counter + 1))
    done
    
    echo "$folder_name"
}

# Create script template
create_script_template() {
    local script_file="$1"
    
    cat > "$script_file" << 'EOF'
#!/bin/bash

# =============================================================================
# SCRIPT NAME
# M√¥ t·∫£: M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ script
# T√°c gi·∫£: Your Name
# Ng√†y t·∫°o: $(date +%Y-%m-%d)
# =============================================================================

set -euo pipefail

# H√†m ch√≠nh
main() {
    echo "Hello World!"
    # Th√™m code c·ªßa b·∫°n ·ªü ƒë√¢y
}

# Ch·∫°y h√†m ch√≠nh n·∫øu script ƒë∆∞·ª£c execute tr·ª±c ti·∫øp
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
EOF

    # Replace date placeholder
    sed -i "s/\$(date +%Y-%m-%d)/$(date +%Y-%m-%d)/g" "$script_file"
}

# ======================== MAIN WORKFLOW FUNCTIONS ========================

# Get file name from user
get_filename() {
    local filename
    
    while true; do
        echo
        read -p "Nh·∫≠p t√™n file script (kh√¥ng c·∫ßn .sh): " filename
        
        if [ -z "$filename" ]; then
            log "ERROR" "T√™n file kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng"
            continue
        fi
        
        if validate_filename "$filename"; then
            echo "$filename"
            return 0
        fi
    done
}

# Get repository URL
get_repo_url() {
    local repo_url
    
    while true; do
        echo
        read -p "Nh·∫≠p URL repository GitHub: " repo_url
        
        if [ -z "$repo_url" ]; then
            log "ERROR" "URL kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng"
            continue
        fi
        
        if validate_github_url "$repo_url"; then
            echo "$repo_url"
            return 0
        fi
    done
}

# Test repository connection
test_repo_connection() {
    local repo_url="$1"
    local max_attempts=3
    local attempt=1
    
    log "INFO" "Ki·ªÉm tra k·∫øt n·ªëi repository..."
    
    while [ $attempt -le $max_attempts ]; do
        show_progress $attempt $max_attempts
        
        if timeout 10 git ls-remote "$repo_url" >/dev/null 2>&1; then
            log "INFO" "K·∫øt n·ªëi repository th√†nh c√¥ng"
            return 0
        fi
        
        if [ $attempt -lt $max_attempts ]; then
            log "WARN" "L·∫ßn th·ª≠ $attempt/$max_attempts th·∫•t b·∫°i, th·ª≠ l·∫°i sau 3 gi√¢y..."
            sleep 3
        fi
        
        attempt=$((attempt + 1))
    done
    
    log "ERROR" "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn repository sau $max_attempts l·∫ßn th·ª≠"
    return 1
}

# Main workflow
main_workflow() {
    local filename folder_name script_file repo_url
    local total_steps=9  # Updated to include SSH setup
    local current_step=0
    
    echo
    echo "üöÄ GITHUB SCRIPT CREATOR - Phi√™n b·∫£n Pro v·ªõi Auto SSH Setup"
    echo "================================================================="
    
    # Step 1: Load config
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    load_config
    
    # Step 2: Setup Git config
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    setup_git_config
    
    # Step 3: Setup authentication (includes SSH auto-setup)
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    if ! setup_auth; then
        log "ERROR" "Kh√¥ng th·ªÉ thi·∫øt l·∫≠p x√°c th·ª±c GitHub"
        exit 1
    fi
    
    # Step 4: Get filename
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    filename=$(get_filename)
    folder_name=$(get_unique_filename "$filename")
    script_file="${filename}.sh"
    
    # Step 5: Create directory and file
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    log "INFO" "T·∫°o th∆∞ m·ª•c: $folder_name"
    mkdir -p "$folder_name"
    cd "$folder_name"
    
    create_script_template "$script_file"
    chmod +x "$script_file"
    log "INFO" "ƒê√£ t·∫°o file $script_file v·ªõi template c∆° b·∫£n"
    
    # Step 6: Edit file
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    log "INFO" "M·ªü editor ƒë·ªÉ ch·ªânh s·ª≠a file..."
    
    if ! "$DEFAULT_EDITOR" "$script_file"; then
        log "ERROR" "C√≥ l·ªói khi ch·ªânh s·ª≠a file"
        exit 1
    fi
    
    if [ ! -s "$script_file" ]; then
        log "ERROR" "File r·ªóng ho·∫∑c kh√¥ng ƒë∆∞·ª£c l∆∞u"
        exit 1
    fi
    
    # Step 7: Git operations
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    
    git init >/dev/null 2>&1
    git add "$script_file"
    git commit -m "Th√™m script $script_file

- T·∫°o b·ªüi GitHub Script Creator v2.0
- Ng√†y t·∫°o: $(date '+%Y-%m-%d %H:%M:%S')
- T√°c gi·∫£: $(git config user.name)" >/dev/null 2>&1
    
    # Step 8: Get repository URL and test connection
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    
    repo_url=$(get_repo_url)
    
    if ! test_repo_connection "$repo_url"; then
        log "ERROR" "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn repository"
        exit 1
    fi
    
    # Step 9: Push to GitHub
    current_step=$((current_step + 1))
    show_progress $current_step $total_steps
    
    git remote add origin "$repo_url" 2>/dev/null || true
    git branch -M "$DEFAULT_BRANCH"
    
    log "INFO" "ƒêang ƒë·∫©y code l√™n GitHub..."
    if git push -u origin "$DEFAULT_BRANCH" 2>&1 | tee -a "$LOG_FILE"; then
        echo
        log "INFO" "üéâ HO√ÄN TH√ÄNH! Script ƒë√£ ƒë∆∞·ª£c ƒë·∫©y l√™n GitHub th√†nh c√¥ng"
        log "INFO" "üìÅ Th∆∞ m·ª•c: $(pwd)"
        log "INFO" "üìÑ File: $script_file"
        log "INFO" "üîó Repository: $repo_url"
        log "INFO" "üìä Log file: $LOG_FILE"
    else
        log "ERROR" "C√≥ l·ªói khi ƒë·∫©y code l√™n GitHub"
        exit 1
    fi
}

# ======================== COMMAND LINE INTERFACE ========================

# Show help
show_help() {
    cat << EOF
GitHub Script Creator - Phi√™n b·∫£n t·ªëi ∆∞u v·ªõi Auto SSH Setup

T√çNH NƒÇNG CH√çNH:
    ‚úÖ T·ª± ƒë·ªông t·∫°o SSH key n·∫øu ch∆∞a c√≥
    ‚úÖ H∆∞·ªõng d·∫´n add SSH key v√†o GitHub step-by-step  
    ‚úÖ Auto-copy SSH key v√†o clipboard (Windows)
    ‚úÖ Ki·ªÉm tra k·∫øt n·ªëi GitHub v·ªõi feedback chi ti·∫øt
    ‚úÖ Template script c√≥ s·∫µn
    ‚úÖ Progress tracking v√† error handling

C√ÅCH D√ôNG:
    $0 [OPTIONS]

C√ÅC T√ôY CH·ªåN:
    -h, --help          Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n n√†y
    -n, --name NAME     T√™n file script (kh√¥ng c·∫ßn .sh)
    -r, --repo URL      URL repository GitHub  
    -e, --editor EDITOR Editor ƒë·ªÉ ch·ªânh s·ª≠a (m·∫∑c ƒë·ªãnh: nano)
    -v, --verbose       Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt
    --version           Hi·ªÉn th·ªã phi√™n b·∫£n

V√ç D·ª§:
    $0                                  # Ch·∫ø ƒë·ªô interactive (khuy√™n d√πng)
    $0 -n backup-script                 # T·∫°o script v·ªõi t√™n c·ª• th·ªÉ
    $0 -n test -r git@github.com:user/repo.git
    
QUY TR√åNH T·ª∞ ƒê·ªòNG:
    1. üîç Ki·ªÉm tra SSH key c√≥ s·∫µn
    2. üîë T·∫°o SSH key m·ªõi n·∫øu ch∆∞a c√≥  
    3. üìã H∆∞·ªõng d·∫´n add v√†o GitHub (auto-copy key)
    4. ‚úÖ Test k·∫øt n·ªëi GitHub
    5. üìù T·∫°o script v·ªõi template
    6. üöÄ Push l√™n repository

EOF
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -n|--name)
                if [ -n "${2:-}" ]; then
                    PRESET_FILENAME="$2"
                    shift 2
                else
                    log "ERROR" "Thi·∫øu t√™n file cho option -n/--name"
                    exit 1
                fi
                ;;
            -r|--repo)
                if [ -n "${2:-}" ]; then
                    PRESET_REPO="$2"
                    shift 2
                else
                    log "ERROR" "Thi·∫øu URL repository cho option -r/--repo"
                    exit 1
                fi
                ;;
            -e|--editor)
                if [ -n "${2:-}" ]; then
                    DEFAULT_EDITOR="$2"
                    shift 2
                else
                    log "ERROR" "Thi·∫øu t√™n editor cho option -e/--editor"
                    exit 1
                fi
                ;;
            -v|--verbose)
                set -x
                shift
                ;;
            --version)
                echo "GitHub Script Creator v2.0"
                exit 0
                ;;
            *)
                log "ERROR" "T√πy ch·ªçn kh√¥ng h·ª£p l·ªá: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# ======================== MAIN EXECUTION ========================

main() {
    # Parse command line arguments
    parse_args "$@"
    
    # Create log file
    touch "$LOG_FILE"
    log "INFO" "B·∫Øt ƒë·∫ßu script - Log file: $LOG_FILE"
    
    # Run main workflow
    main_workflow
    
    # Final cleanup
    log "INFO" "Script ho√†n th√†nh th√†nh c√¥ng!"
}

# Execute main function if script is run directly
# Handle both normal execution and curl | bash execution
if [[ -z "${BASH_SOURCE[0]:-}" ]] || [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
